<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stanbic Receipt Generator</title>
<style>
body{font-family:"Segoe UI",Arial;background:#f2f2f2;margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;}
.wrapper{max-width:420px;width:90%;background:white;padding:20px;border-radius:12px;box-sizing:border-box;}
h2{text-align:center;margin-bottom:15px;font-size:18px;}
input,button{width:100%;padding:12px;margin-top:8px;border-radius:6px;border:1px solid #ccc;font-size:14px;box-sizing:border-box;}
button{background:#1c2c8c;color:white;border:none;cursor:pointer;}
#codeModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:9999;}
.modalContent{background:white;padding:20px;width:90%;max-width:300px;border-radius:10px;text-align:center;}
</style>
</head>
<body>

<div class="wrapper">
<h2>Stanbic IBTC Transaction</h2>

<input id="sender" placeholder="Sender Name">
<input id="senderAcc" placeholder="Sender Account">
<input id="beneficiary" placeholder="Beneficiary Name">
<input id="beneficiaryAcc" placeholder="Beneficiary Account">
<input id="beneficiaryBank" placeholder="Beneficiary Bank">
<input id="amount" placeholder="Amount">
<input id="narration" placeholder="Narration">

<button onclick="showCodeModal()">Generate Receipt</button>
</div>

<div id="codeModal">
  <div class="modalContent">
    <h3>Enter Access Code</h3>
    <input id="userCode">
    <button onclick="verifyCode()">Submit</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBCXfc6oFNUkx1qLWZt5ZqpY2yYzn0OTio",
  authDomain: "stanbic-pro.firebaseapp.com",
  projectId: "stanbic-pro",
  storageBucket: "stanbic-pro.firebasestorage.app",
  messagingSenderId: "430146762267",
  appId: "1:430146762267:web:7653262e8cba7c1cc02abe"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

function showCodeModal(){document.getElementById("codeModal").style.display="flex";}

async function verifyCode(){
  const codeInput = document.getElementById("userCode").value.trim();
  if(!codeInput){ alert("Enter access code"); return; }

  const q = query(collection(db,"accessCodes"), where("code","==",codeInput));
  const snap = await getDocs(q);
  if(snap.empty){ alert("Invalid code"); return; }

  let docData, docId;
  snap.forEach(d=>{ docData=d.data(); docId=d.id; });

  const now = Date.now();
  if(docData.used){ alert("Code already used"); return; }
  if(now > docData.expires){ alert("Code expired"); return; }

  await updateDoc(doc(db,"accessCodes",docId), {used:true});

  const receiptData = {
    sender: document.getElementById("sender").value,
    senderAcc: document.getElementById("senderAcc").value,
    senderBank: "STANBIC IBTC BANK",
    beneficiary: document.getElementById("beneficiary").value,
    beneficiaryAcc: document.getElementById("beneficiaryAcc").value,
    beneficiaryBank: document.getElementById("beneficiaryBank").value,
    amount: document.getElementById("amount").value,
    narration: document.getElementById("narration").value,
    date: new Date().toLocaleString(),
    ref: Math.floor(Math.random()*1000000000000)
  };

  sessionStorage.setItem("receiptData", JSON.stringify(receiptData));
  location.href = "receipt.html";
}
</script>
</body>
</html>